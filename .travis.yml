language: python            # this works for Linux but is an error on macOS or Windows
sudo: required
cache: pip

matrix:
  include:
    # Linux
    - name: "Python 3.7.1 on Ubuntu Linux 16.04 (Xenial)"
      python: 3.7           # this works for Linux but is ignored on macOS or Windows
      dist: xenial
      env: BADGE=linux
    # macOS
    - name: "Python 3.7.0 on macOS 10.13 (High Sierra)"
      os: osx
      osx_image: xcode9.4   # osx_image: xcode11 --- Python 3.7.4 running on macOS 10.14.4
      language: shell       # 'language: python' is an error on Travis CI macOS
      before_install:
        - python3 -m venv $TRAVIS_BUILD_DIR/.python-venv # create virtual environment for convenience
        - source $TRAVIS_BUILD_DIR/.python-venv/bin/activate # activate virtual environment
      env: BADGE=osx
    # Windows
    - name: "Python 3.7.4 on Windows 10.0"
      os: windows           # Windows 10.0.17134 N/A Build 17134
      language: shell       # 'language: python' is an error on Travis CI Windows
      filter_secrets: false
      before_install:
        - choco install python --version=3.7.4 # 3.8 fails with cryspy
        ##- choco install zip
        ##- choco install curl
        ##- choco install grep
        ##- choco install sed
        ##- pip install pypiwin32
      env:
        - PATH=/c/Python37:/c/Python37/Scripts:$PATH
        - BADGE=win

env:
  global:
    # GH_TOKEN
    - secure: "iUDKM5LbuZIrxqYewO4g8GKbpCvdIwbQckYVX9tj9pP9outFNzLicu7gGpL3gSkl52kzWQk8wtsE27Yx4EYE4i5N6h64Czqenhu+pt0wl84Rne0hq36jugHvXz6L8wGibdM/dq99AS78ctGE733FHgPwv5K7CF4iyWaJlj7CKR1F7UN/HcoFFUJ9yfsIsgYWHYOwniDo6NDVRyI+DI15CwrAQDcOBYP1wIAPDemTciVi3BHiFFS3ORuf32Fug69pIAuO/8mPWJP+seecxcXS4wLbxxru8LFMx3/fPv971QR1c7gZHPAIK9kQUFFVRm7g9giA+hhVFZFfLxzgBBJXpTuQoTDusjTlt+l3om8w692vpMuccZ0/CEAv6vM1P7g+vWur/e6jmi5NvA291bv3ijCRfN6wrYLbhuZx4JqT0R6T/CY/+jAKpfvl/ktqe6KNK/lQJqh9Ug9FO5+/w+lNZyOXFgIlQbijC3DgdyCK2rHlnBS67XCWDixQUYeCC/slhRo0mtkphWg+mNnJT5vq7GFEpLupl4pRfi/HK805Pzj4GjdBZXxTcHzSEwdDZRXb7puoZrmATLQo+jbAqz4UgUs3EKcjXIt66HIeaL8qr6hVDZ51Xhuk+iY9E06DijnqGZ7zIRfXFu3cbSvWwwuPCjtY1qxzlTaG1esWPMI9Mgc="
    # CODE_SIGN_PSWD_DICT
    #- secure: "piEk/xmJ3nD+n6y0jz8oVrj0mdGhWcKf2SUK+X3aXfhofyhLP4luUIcdAMpzQOCMy7yD2wZHwtk/9mFQc5le65Rp7yNFjMqgmknNAWZ9HC+rhpHEj4xPoWhHy6HCovM949KE/q9y7vx+wEW+g1uQhTGFnUPBmJiSSv0lJ+QYoARlPFBBpE6PZC2vnkn42RjqW9ctX9EhrcRcN38aEIJ6l3wsdAdk5J34URAtBUtMFByAWMpWSkub1KS3fAZ6GFMnJUr4lqAgFUKax6+OB4WNzSxk/sp5ev9/LA6KziobXxIVcchpg09XeGiTkgazUWqLHztrzHgbMcsdX46KMXRjIX0ER9MBu4aq2MMz6w1Gjbht+GzsnsAfnkx8SlDcZVe7t8Gaz/qo7EEg1iLuBfxpm9Crs2+UFDTG6FeLw4mDjAOU7mVABWHsDoWCVgZDvaNP0DRyCQleVbObEkzPbPF7Hsyfi+bn9LXguuzioYQS91+ILllXwW3xenEJ/tTBGtEjsLKQ4Qogyte2BcqQt3OYJUDVb4LCJJfyZXBIk2FFpRJTDiC7Z+1qxjodu0521k0K2S7KYCai6wRBbHF4vZu3d9fec8GX10A3N0GWotq+xM7/F4IIU9vbr6yS/ANAgIXoIk4xdfw0jnnC0Lt80oOgpw4+bOQmVR375a/nFvv+vPs="
    - secure: "Rv+X51EyK/k1d7ssxIZTFCM2Sq6RLmoM8codNCGi6fYMAczMZsFb54zEW2GRlxh94OlW0UeBOTWRvZYKm0g2JF6PXquPMhEsSwWK9q4IMAO40xMzt4azC80oIK8rv0ewjgPzpFhZODmaHWf8vHTRF/Eslb6qzaqy8UCohg+YUKiu1Q0uuCWYqcmJsBqDsnX4tuLrOPW2MpUqwHM4r7nQDcTSucXEAPIvDSSB5rt6bgipfIa1+igKoDUTG3qucU6T6gjGzdm7bBjHA0iA5tPjKgd7x5ppS5QqVsFOE8ERvKZokSYo4oByTLP/xThYdiaWbokKN/w6ouG6A/RdhIZkVd1FgNd0sjM55k70nDB66draWrP6Ph5IlPgrfYGgwF0vc2+uVRMxZ3sjgn7q6a/erJdIiwyaGc9NIKluSp3hPuI6QS9Aa2yZ/iW/xGAMMOzBHDwiryupnBzdimeIo8hQ9hXMtslFm9LFbuWQwbZTHgUUk4LLeyM9rBu806pBt4PXBlhZ7YMwTE0fdkt1Xm84X0xV6NCeaZ9q1iiK/5L6QVYTjBnTccXGb9C3LPqZ4uuU0gMXkc4vd58h11l4cHx89svnm2qEo7DPtIi/dFF82pQ5fbdWsCSuzQ21PRz42xH/iN7uphMo6de4bo4IWJmXEcD9MwfUgbLzzCheUpHXgTY="
    # CERTIFICATES_ZIP_PSWD
    - secure: "Oe0a+jCSrdw3sqG3hpMu5DkrpLJD4upkW2krWdq11ereul5JdHLfkGRVGPnzS6riEoSee5pzhTQKFdFRYMCslOiXn+wuKu0izXQ2Ye27vjvFQSN1DQkPlasH6Z6q8ATic2m4aoUyXojy/kgRvr/DfsAF+Mzirg/N81HnXqAP/dZka8LRJCsytmuaHTWMrtubrQ/lBtSCeppuXEjR4dhXu4BUL3qX1s9eGQ6WhKbyK5pjXxeP08uHyWqUIr5Pse7FJnCw8ua8mIYRtm+Ew265I886cfl0tC3DcZy+Jmo2KFTRK/OjU+2v6rWETUrBZpdoBPHkMUfKklGKW09Js2O3HkxEr3L9nhYtbxttJVWOGpHIvrDUnlCo1O/Lgv92oV3/0FybSiNiC4t+zZPyPesxEKcegEG5r/v5BSEVHiREePgovwpZ0zhyP9KbcG9SmC2RLx1sgPpBoxIOJg/NrYi++uf2gH8iLfZwSm+/tS5kUC3M7joPGvs1yU5Q8rriUKRhp41oEvvU7ZPjlZM0CdgxwT+wo0qX87BjD68J6UPp/wC0UPgbkv78FX3SLDxwFoptDpn+Id2IlJ85O+ZO8aF9di30kLv/WGULlXbGup8ZdCN9vkUPrZ0HKUD9ebKNe0KH/SEkRO56qYiZGwtdZ0X4sLLR2ALBpuRclPJY7udOVAY="
    - secure: "I7tpFrOFzM0C+BJXJvWsujIIoZT5k8vliJvu8Ci32DNupfexkYY4cvwQDCT/SznUoRE2fEVYJgPGYToQI9iNO2cQ1DLgKXdHwxe3CHTLVhGzURdlXzXgykMsc24Lv9byCvpt8uHJRf6+QQ4WUOqY2TBYGxw88s7Pi6s+sztSh95eX93Ov8nlPfRrm1uesEWVrD64YN82ej7iUvr/bRmdq9zmap+NZ4Q7pq8Ks2ARyRnhlixpPNNG/4r0EjiRpuautQMsEnhSt89K9/G279Wu0Nhp55xycEUCv5Bxs+M5EdnTrBYWxknPD/41CIHY1xN1Dol+SLEdadN3qnLkMSdOO5phOO/msGbpNvHjx7+7fVy90cheWfZAGjw4urQL9L5mKk+aO8Fm1BSi2sIM4BxtXGEvzkQOT5mlBLwHqlANaSW6WlJTnn9cjTrPyMuIxGgty1F7vV+GpMjRYn6zYJYnpKm1nXpSREnhAkxQNMIapRLGeFIlYflGpKrK8CDPyoxUPvMpddUqb2t/LqOT6h+aMZ3tUEN0kb40tWs1IeSyBvoJQert5jv4kxVXG/Hm9LmZILcxCPEoN7grZqOJPI8Cubn+q0cmsQdhFAW8BN/RktDN2z6F0MPMiGpPvZr3CykDHpkLeHY0j2h/Z50pW2BcsWzSKJyUGP5+7A/21msR0Xc="

install:
  # Vars
  - echo $TEST_PSWD2
  - pip install requests
  - python Scripts/SignCode.py $TRAVIS_OS_NAME $TEST_PSWD2
  - djgnekrjbvkerjb
  - export RELEASE_NUMBER=$(cat App/QmlImports/easyDiffraction/Settings.qml | grep 'appVersion' | sed 's/.*"\(.*\)"[^"]*$/\1/')
  - if [ $TRAVIS_BRANCH = "master" ]; then export TRAVIS_TAG=v$RELEASE_NUMBER; else export TRAVIS_TAG=$TRAVIS_BRANCH-v$RELEASE_NUMBER; fi
  - export RELEASE_TITLE=easyDiffraction-$TRAVIS_TAG
  - echo $RELEASE_NUMBER
  - echo $TRAVIS_TAG
  - echo $RELEASE_TITLE
  - if [ $TRAVIS_BRANCH != "master" ]; then export NOT_MASTER_BRANCH=true; else export NOT_MASTER_BRANCH=false; fi
  - echo $NOT_MASTER_BRANCH
  # Python
  - python --version
  # PIP
  - python -m pip install --upgrade pip
  - pip --version
  # Install
  - pip install requests
  - pip install cryspy==0.1.12
  - pip install PySide2==5.13.1
  - pip install pyinstaller==3.5
  - pip install pytest
  - pip install pytest_mock
  - pip install pytest-cov
  - pip install pytest-qt
  - pip install coveralls

before_script:
  #- python Scripts/CompilePyResource.py
  - python Scripts/CopyMissingLibs.py $TRAVIS_OS_NAME
  - python Scripts/MakeDist.py $TRAVIS_OS_NAME

#script:
  #- pytest --version
  #- if [ "$TRAVIS_OS_NAME" == osx ]; then export PYTHONPATH=.:App:App/PyImports:$PYTHONPATH; pytest --cov=App Tests; fi
  #- if [ "$TRAVIS_OS_NAME" != osx ]; then python runTests.py; fi

after_success:
  - python Scripts/MakeInstaller.py $TRAVIS_OS_NAME
  - python Scripts/SignCode.py $TRAVIS_OS_NAME $CODE_SIGN_PSWD_DICT $CERTIFICATES_ZIP_PSWD
  - zip -j easyDiffraction-$TRAVIS_OS_NAME-v$RELEASE_NUMBER.zip dist/easyDiffractionInstaller*
  #- coveralls

#cache:
#  directories:
#    - ~/easyDiffraction

before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "Travis CI"
  - git config --local user.email "travis@travis-ci.org"
  # This writes a changelog. If wanted
  #- '[ "$TRAVIS_BRANCH" != master ] || cd ../ && pip3 install gitchangelog pystache && echo "output_engine = mustache(\"markdown\")" > .gitchangelog.rc && gitchangelog ^$(git describe --abbrev=0 --tags) HEAD > CHANGELOG'

deploy:
  - provider: releases # GitHub repository
    name: $RELEASE_TITLE
    api_key:
      secure: "s3uqRW5prwmZp8dFSroXQCUBOFOCVU10iSGMVfBCtn51HDmF/RXDlQw7UJHs8vJJbtY+0tQ2yByCj5nah6VzaXKVyvxl7/VXGgB67LkHaI4idKV8HOqcSShJ1sxGapvMC3u5Ezx8tg3cK09SJnSFXq/xk9NoTdmxuFDX6X9P3jRq/CKM5mkHkOiUWLeU86sulJiBIBdcYoFwIXOKQE5KlDDBFDiI/qnEC98B4lKMSzRQB5VQEXeW+Z4f7KsK7/aS8H+Tw0sA+P81TN8CVXBeWAhBpEzrSAxLGEMRTP5GY/AkiJbdBuJMmHcc1t0S79OBsKQcrV2Yl9CtN4/WuvIH2caX19z39AvfjzDyHMnkDzN0XBv5fvQYla/45PxdmQf8O6GaiITXewBu+1DT9nQzLLaLh6GHz/zdGZeO2/ivwBMQnd8A3+B8YaO5/2dYGndAPDt06ECQBKI6RGvEBfTjApSTnuX07CjAwkXyg39uZo4KRtF1FGSjZdcNaDQGByPNHu4IOM60xDgM7VHI0EBz5YfZMpVs0sVTIsnwe7m+tFzRa00E/mlFdPCUvpYeZxgBJpNIvoBA53R7hUcvPd/xNeTfiT7tF08cAc3rdm+Mmdeewifn91SGunUBwLiNBVLB6YVlIfj2Btkce5fgdLTkVGnBlnawGAZtJwtH1Z6EJR4="
    skip_cleanup: true
    draft: true #$NOT_MASTER_BRANCH # true: only repository collaborators can see
    overwrite: true
    file_glob: true
    file: easyDiffraction-*.zip
    on:
      all_branches: true

after_deploy:
  -  |
     if [ $TRAVIS_BRANCH = "master" ]; then
        cd ~/
        git clone https://github.com/easyDiffraction/easyDiffraction.github.io.git
        cd easyDiffraction.github.io
        git remote set-url origin https://$GH_TOKEN@github.com/easyDiffraction/easyDiffraction.github.io.git
        cat index_template.html | awk '{gsub(/RELEASE_V/,"'$TRAVIS_TAG'")}1' | awk '{gsub(/RELEASE_N/,"'$RELEASE_NUMBER'")}1' | awk '{gsub(/RELEASE_D/,"'$(date +'%d %b %Y')'")}1' > index.html
        git add index.html
        git commit -m 'Bumped release links [ci skip]'
        git push origin HEAD:master
     fi

notifications:
  slack:
    rooms:
      - secure: "t0nR618a2fr2EDpyfKWBBkcf5MJ549P732EGvN9gwXVYvl4z977KSSH6uPEw7/KmMec9BhMg882hJidoeh1XgvUQOiVan4jrlvn16z2INPWh/dloXOZN5YWz87tSLR1jn1tDaKSK7gaOF5HAosPbQ2/UriUaAG9d9GHJKJzCogNDAFwFge3K/b4KJr1kYpwS5Vd5K99peWnsrNYBz1M4+Xjc49cd5t5FKULtFduX0Zb25t3dQ25u9LfGQ5lyH65UNSqcu9DP4RZmX00KLYNnIOYtzuyWvehPhisoBozA+Fpuly2IaFPVswtHqO/h9kziyYBBcnEAvG0U+KHmkJy21vDHN5+yPoHlcuAr0Q95C7GEpUT/JVAeNggxWWF4WLYrcTbZXWGt69pBhuFUAZRnbzSV+wBF5ZAOK/5W9TvxYMM1uS9AqdLEmUQdtIGrj2VIDS1na0dielNMnOhBc0Xgap2as/Kb1aEkPuSA6kENDOGXrw1Vs0VjFK3iWOlyzHbfHdHWM1/WZOO2sZRNjdTgWS5x5UXJbozTcM5mzcAkZ21vVpVG5h7LQI3cMPpD45Hmtmnko6S+7FlaknesIeXXhZPwILxN12LtbBo7AkUqtdi/w4Do7CAA++hNJRQx2txa9Mfi6R9XhNccc9+3Mto6lw5hW9mDmb2b1TlrLksW5Ew="
    on_success: always
    on_failure: always

#https://docs.travis-ci.com/user/job-lifecycle/
